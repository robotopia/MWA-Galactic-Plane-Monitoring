#! /bin/bash -l

set -x

obsnum=OBSNUM

# If obsnum is a file, then we are in an array job
if [[ -f "${obsnum}" ]]
then
    taskid="${SLURM_ARRAY_TASK_ID}"
    jobid="${SLURM_ARRAY_JOB_ID}"

    echo "obsfile ${obsnum}"
    obsnum=$(sed -n -e "${SLURM_ARRAY_TASK_ID}"p "${obsnum}")
    echo "image obsid ${obsnum}"
else
    taskid=1
    jobid="${SLURM_JOB_ID}"
fi

echo "jobid: ${jobid}"
echo "taskid: ${taskid}"

function test_fail {
if [[ $1 != 0 ]]
then
    track_task.py fail --jobid="${jobid}" --taskid="${taskid}" --finish_time="$(date +%s)"
    exit "$1"
fi
}

# Go to working directory
base=BASEDIR

# Update database
cd "${base}" || exit
track_task.py start --jobid="${jobid}" --taskid="${taskid}" --start_time="$(date +%s)"

datadir="${base}/${obsnum}"
cd "${datadir}" || exit

# Calculate the Stokes V leakage, and fix
subchans="0000 0001 0002 0003 MFS"
for subchan in $subchans
do
    calc_leakage.py \
        --Inonpb ${obsnum}_deep-${subchan}-I-image.fits \
        --Ipb ${obsnum}_deep-${subchan}-I-image-pb.fits \
        --Vpb ${obsnum}_deep-${subchan}-V-image-pb.fits \
        --plots
done

test_fail $?
track_task.py finish --jobid="${jobid}" --taskid="${taskid}" --finish_time="$(date +%s)"
track_task.py obs_status --obs_id="${obsnum}" --status='leakage fixed'


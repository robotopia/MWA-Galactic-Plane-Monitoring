#! /bin/bash -l

set -x

obsnum="$1"
datadir="$2"

# Ensure that the target download directory exists and cd into it
mkdir -p "${datadir}" && cd "${datadir}"

# Make sure that the measurement set hasn't already been downloaded (in full or in part)
if [[ -d "${obsnum}.ms" || -f ${obsnum}_*_ms.tar ]]
then
    echo "${obsnum}.ms or ${obsnum}_*_ms.tar already exists; please remove before trying to (re)download."
    exit 1
fi

# Check the state of the obs preprocessing on ASVO
state="$(giant-squid list "${obsnum}" --json | jq -r ".[]| select( .obsid == ${obsnum} ).jobState")"
state="${state,,}" # convert to lower case

if [[ -z $state ]]; then
    giant-squid submit-conv -p avg_time_res=4,avg_freq_res=40,flag_edge_width=80,output=ms "${obsnum}"
elif [[ "$state" == "ready" ]]; then
    giant-squid download --keep-zip ${obsnum}
    tar -xf ${obsnum}_*_ms.tar
    grep -v birli_manifest.sha1sum birli_manifest.sha1sum | sha1sum -c

    # Check if the download was successful
    if [[ $? -ne 0 ]]; then
        exit 1
    fi

    # The tar file has been successfully extracted, so remove it
    rm ${obsnum}_*_ms.tar
fi

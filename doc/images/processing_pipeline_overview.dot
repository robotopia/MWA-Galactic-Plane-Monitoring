digraph G {
  is_cal [shape=diamond; label="Is this a\ncalibration\nobservation?"];
  postimageI [label="postimage-I"];
  postimageV [label="postimage-V"];
  calsol [shape=rectangle; label="Calibration\nsolution"];
  manta [label="Download data\nfrom ASVO\n(obs_manta)"];
  autoflag [label="Flag tiles\n(obs_autoflag)"];
  autocal [label="Generate cali-\nbration solution\n(obs_autocal)"];
  apply_cal [label="Apply calibration\nsolution\n(obs_apply_cal)"];
  uvflag [label="Apply UV flags\n(obs_uvflag)"];
  image [label="Generate image\n(obs_image)"];
  postimageI [label="Generate deep\nStokes I\n(obs_postimageI)"];
  postimageV [label="Generate deep\nStokes V\n(obs_postimageV)"];
  calc_leakage [label="Correct polari-\nsation leakage\n(obs_calcleakage)"];
  transient [label="Make time cubes\n(obs_transient)"];
  tfilter [label="Apply matched and other filters\n(obs_tfilter)"];

  manta -> autoflag -> is_cal;
  autocal -> is_cal [dir=back; label="Y"];
  autocal:s -> calsol:n;
  apply_cal -> uvflag -> image -> transient -> tfilter;
  image -> postimageI -> postimageV -> calc_leakage;
  calsol -> apply_cal [style=dashed];
  is_cal:s -> apply_cal:n [label="N"];

  {rank="same"; apply_cal; calsol;}
  {rank="same"; is_cal; autocal;}
  {rank="same"; image; postimageI;}
}
